```{r}
library(MultiVarSel)
library(reshape2)
```

```{r, echo=F}

# Importation des données de métabolisme
proteo <- read.table("proteomeAth.csv", header = T, sep = ";", dec = ",")

# Renommage de la première colonne
proteo = proteo[,-1]
temperature = rep(c("FROID", "STD", "CHAUD"), each = 3)
proteo = data.frame(temperature, proteo)
```

# Info sur les données de métabolisme
```{r, echo=F}
print("Nombre de colonne dont la moyenne est nulle :")
which(colMeans(proteo[,2:dim(proteo)[2]])==0)

print("Nombre de colonne dont l'écart type est nul, c'est à dire que la variable est constante :")
which(apply(proteo[,2:dim(proteo)[2]],2,sd)==0)

print("Nombre de NAs dans le dataframe :")
which(is.na(proteo))
```

# Récupération et opérations sur les matrices Y et X

```{r, echo=F}
Y <- as.matrix(proteo[, -1])
X <- model.matrix(lm(Y ~ temperature + 0,data=proteo))
p <- ncol(X)
print("Lignes de X")
n=nrow(X)
print(n)

print("Colonnes de Y")
q=dim(Y)[2]
print(q)
```

```{r, echo=F}

## Scaling the Y matrix (to force the empirical mean of each column
## to be 0 and the variance of each column to be 1)
Y=scale(Y)

## Definition of the residuals
residus=lm(as.matrix(Y)~X-1)$residuals
## Whitening test without using any whitening method
pvalue=whitening_test(residus)
print(c("p-valeur du test de blancheur : ", pvalue))
```

## Trouver la structure du bruit des résidus
```{r, echo=F}
## Testing the two dependence structures (parametric : AR1 and Nonparametric) : Toeplitz case
whitening_choice(residus, typeDeps = c("AR1","nonparam", "ARMA"), pAR = 2, qMA = 1)
```
On voit donc que lorsque l'on applique la structure non paramétrique la valeur p de $0.741$ nous indique que parmi les fonctions testées c'est la structure non paramétrique qui permet de blanchir la matrice.

```{r, echo=F}
## => We will use the nonparametric modeling.
square_root_inv_hat_Sigma=whitening(residus,"nonparam",pAR=1,qMA=0)
```

## Sélection de variables

```{r, echo=F, fig.show="hide"}
# Freqs_TOEPLITZ = variable_selection(
#   Y,
#   X,
#   square_root_inv_hat_Sigma,
#   nb_repli = 5000,
#   parallel = F,
#   nb.cores = 1
# )
# save(Freqs_TOEPLITZ, file = 'Freqs_proteome_Ath_TOEPLITZ_nbreplis_5000.Rdata')
# 
load('Freqs_proteome_Ath_TOEPLITZ_nbreplis_5000.Rdata')

colnames(Freqs_TOEPLITZ) <- c('Names_of_Y', 'Names_of_X', 'frequency')
base::plot(sort(Freqs_TOEPLITZ$frequency,decreasing = T), type = 's')

sort(Freqs_TOEPLITZ$frequency,decreasing = T)[1:50]

```


```{r}
seuil=0.95

Freqs_TOEPLITZ$Names_of_X=gsub(pattern='temperature',replacement='',Freqs_TOEPLITZ$Names_of_X)

indices=which(Freqs_TOEPLITZ$frequency>=seuil)

Yvec=as.numeric(Y%*%square_root_inv_hat_Sigma)
Xvec=kronecker(t(square_root_inv_hat_Sigma),X)
Xvec_sel=Xvec[,indices]
B_sel_hat=solve(t(Xvec_sel)%*%Xvec_sel,t(Xvec_sel)%*%Yvec)
Freqs_TOEPLITZ$estim=rep(0,p*q)
Freqs_TOEPLITZ$estim[indices]=as.vector(B_sel_hat)

library(ggplot2)
gr<-ggplot(data=Freqs_TOEPLITZ[Freqs_TOEPLITZ$frequency>=seuil,],
           aes(x=Names_of_Y,y=Names_of_X,color=estim))+
  scale_color_gradient2(low="steelblue",mid = "white", high ="red")+
  geom_point(size=2)+theme_bw()+
  ylab('Température')+
  xlab('Métabolites')+theme(axis.text.x = element_text(angle=90))
gr

```


```{r,fig.width=18,fig.height=20}

#### Boxplots

table_red=as.data.frame(Y[,colnames(Y)%in%unique(Freqs_TOEPLITZ[indices,]$Names_of_Y)])
table_red$temperature=proteo[,1]

bp <- ggplot(melt(table_red), aes(x=temperature, y=value,fill=temperature)) + 
  geom_boxplot()+theme_bw()+theme(axis.text.y =element_text(size=20),axis.text.x =element_text(size=15),axis.title =element_text(size=20),legend.title=element_text(size=20), 
    legend.text=element_text(size=19))
bp+facet_wrap(~variable,ncol=3)+ylab("Réponse")+theme(strip.text = element_text(face="bold", size=20))


#### Sans la fonction melt
# matrice=table_red[,1:length(unique(Freqs_TOEPLITZ[indices,]$Names_of_Y))]
# table_boxplot=data.frame(Reponse=c(t(unlist(t(matrice)))),
#    temperature=rep(table_red$temperature,length(unique(Freqs_TOEPLITZ[indices,]$Names_of_Y))),
#    nom=rep(unique(Freqs_TOEPLITZ[indices,]$Names_of_Y),each=length(table_red$temperature)))
# 
# bp <- ggplot(table_boxplot, aes(x=temperature, y=Reponse)) + 
#   geom_boxplot()+theme_bw()
# bp+facet_wrap(~nom,ncol=3)

### Autre façon de faire un boxplot
# boxplot(Y[,which(colnames(Y)=="Maleate")]~temperature,main="proteine Maleate")
```

```{r,fig.width=10,fig.height=10,echo=FALSE}
liste_proteines_selected=unique(Freqs_TOEPLITZ[indices,]$Names_of_Y)
# length(liste_proteines_selected)
# 
# residus_red=residus[,colnames(residus)%in%liste_proteines_selected]
# 
# hc=hclust(dist(t(residus_red)),'ward')
# 
# hc=hclust(dist(1 - abs(cor(residus_red))))
# base::plot(hc)
# rect.hclust(hc,k=5)

```

# Exportation des Protéines sélectionnées par GLM Lasso
```{r}
table_selection <- liste_proteines_selected

# export

write.table(
  table_selection,
  file = "protein_selection_lasso.csv",
  append = F,
  sep = ";",
  dec = ".",
  row.names = T,
  col.names = NA,
  fileEncoding = "UTF-8"
)


```



